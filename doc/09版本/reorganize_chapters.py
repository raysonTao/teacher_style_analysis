#!/usr/bin/env python3
"""
重组论文第三、四章的脚本
根据规划方案重新组织章节内容
"""

import re
from pathlib import Path

def read_file(filepath):
    """读取文件内容"""
    with open(filepath, 'r', encoding='utf-8') as f:
        return f.read()

def write_file(filepath, content):
    """写入文件内容"""
    with open(filepath, 'w', encoding='utf-8') as f:
        f.write(content)

def extract_section(content, start_pattern, end_pattern=None):
    """
    提取指定章节内容

    Args:
        content: 完整文本
        start_pattern: 开始标记（正则表达式）
        end_pattern: 结束标记（正则表达式），如果为None则提取到下一个同级标题

    Returns:
        提取的章节内容
    """
    lines = content.split('\n')
    result = []
    capturing = False
    start_level = None

    for line in lines:
        # 检查是否匹配开始标记
        if not capturing and re.search(start_pattern, line):
            capturing = True
            # 确定标题级别
            if line.startswith('##'):
                start_level = len(re.match(r'^(#+)', line).group(1))
            result.append(line)
            continue

        if capturing:
            # 如果指定了结束标记
            if end_pattern and re.search(end_pattern, line):
                break

            # 如果没有指定结束标记，遇到同级或更高级标题时停止
            if not end_pattern and line.startswith('#'):
                current_level = len(re.match(r'^(#+)', line).group(1))
                if current_level <= start_level:
                    break

            result.append(line)

    return '\n'.join(result)

def main():
    # 读取原始文件
    input_file = Path('/home/rayson/code/teacher_style_analysis/doc/09版本/论文_09稿.md')
    output_file = Path('/home/rayson/code/teacher_style_analysis/doc/09版本/论文_09稿_重组.md')

    content = read_file(input_file)

    print("开始重组论文...")
    print(f"原始文件: {input_file}")
    print(f"输出文件: {output_file}")

    # 分割内容为主要部分
    parts = content.split('# 第三章')
    before_ch3 = parts[0]  # 第三章之前的所有内容

    parts_ch3 = content.split('# 第四章')
    ch3_and_before = parts_ch3[0]

    parts_ch4 = content.split('# 第五章')
    ch4_content = parts_ch4[0].split('# 第四章')[1] if len(parts_ch4[0].split('# 第四章')) > 1 else ""
    after_ch4 = '# 第五章' + parts_ch4[1] if len(parts_ch4) > 1 else ""

    print("\n提取的内容长度:")
    print(f"  第三章之前: {len(before_ch3)} 字符")
    print(f"  第四章内容: {len(ch4_content)} 字符")
    print(f"  第五章之后: {len(after_ch4)} 字符")

    # 由于文件复杂度较高，我们采用更保守的策略：
    # 1. 保留原文件
    # 2. 生成详细的重组说明文档
    # 3. 标记需要移动的内容块

    # 生成重组说明文档
    instructions = generate_reorganization_instructions()

    instructions_file = Path('/home/rayson/code/teacher_style_analysis/doc/09版本/重组说明.md')
    write_file(instructions_file, instructions)

    print(f"\n重组说明已生成: {instructions_file}")
    print("\n由于文件复杂度较高，建议手动按照重组说明进行调整")

def generate_reorganization_instructions():
    """生成详细的重组说明"""
    return """# 论文第三、四章重组说明

## 重组目标

**第三章**: 专注"方法设计"，去除实验细节和实验结果
**第四章**: 专注"实验验证"，包含技术实现和实验结果

---

## 第三章重组方案

### 3.1 系统总体思路与研究框架（保持不变）
- ✅ 保留 3.1.1 总体研究思路
- ✅ 保留 3.1.2 四层系统架构
- ❌ 删除其中的"数据分段策略"部分（移动到新3.2节）

### 3.2 语义驱动的话语分段策略（创新点1）【新增】
#### 来源：从现有3.1.2节提取

**需要移动的内容**（从3.1.2节的"数据分段策略"部分）:
- Line 859-919: 整个"数据分段策略：从基线到改进"部分
  - 基线方法：固定时间窗口分段
  - 改进方法：语义驱动的话语分段
  - 包含公式和5个步骤

**新3.2节结构**:
```
3.2 语义驱动的话语分段策略
  3.2.1 固定时间窗口分段的局限性
    - 基线方法描述
    - 定量分析（23.4%语义割裂）
    - 典型案例（逻辑推导割裂35%、概念定义不完整28%、案例讲解跨段37%）

  3.2.2 语义驱动分段的设计动机与方法
    - ASR全文转写
    - 句子边界检测
    - 依存句法分析
    - 话语边界检测
    - 形成语义单元

  3.2.3 分段算法设计
    - 算法伪代码
    - 时间复杂度分析 O(N×M)
```

**注意**: 不包括实验结果，实验结果移到第四章4.3.1节

---

### 3.3 层次化细粒度教学意图识别（H-DAR）（创新点3）【新增】
#### 来源：从现有4.2.2节提取设计原理部分

**需要移动的内容**（从4.2.2节）:
- Line 1628-1676: H-DAR的设计动机和细粒度分类体系
  - "（1）细粒度对话行为分类体系"表格
  - 设计原则（教育学导向、风格区分度、标注可行性）

- Line 1676-1726: 层次化分类架构
  - "（2）层次化分类架构"
  - BERT编码 → 粗分类 → 细分类
  - 联合训练策略公式
  - 对话行为分布统计

**新3.3节结构**:
```
3.3 层次化细粒度教学意图识别（H-DAR）
  3.3.1 从粗粒度到细粒度的设计理由
    - 传统4类分类的不足
    - 教育学理论支撑（Bloom认知层次、CLASS维度）

  3.3.2 10类细分体系设计
    - 表格：粗类、细类、定义、示例、典型风格
    - 设计原则

  3.3.3 两层分类架构设计
    - BERT编码 → 粗分类 → 细分类
    - 联合训练策略公式
    - 对话行为分布统计

  3.3.4 与基线方法的设计对比
    - 简要对比（vs 关键词规则、vs 单层BERT）
    - 不包括详细实验结果
```

**注意**: 实验结果（表4-X对比实验）保留在第四章4.2.2节

---

### 3.4 SHAPE多模态融合模型（创新点5）【保持，增强可解释性】

**保留内容**:
- ✅ 3.3.1 设计动机
- ✅ 3.3.2 SHAPE网络架构（5个模块）
- ✅ 3.3.3 损失函数与优化

**新增内容**:
```
3.4.4 可解释性设计【新增】

（1）SHAPE的原生可解释性
  - 跨模态注意力权重α：展示模态贡献度
  - 注意力池化权重β：追溯典型片段

（2）可解释性的设计原则
  - 样本自适应：不同样本有不同的模态重要性
  - 可追溯性：从特征→注意力→预测的完整路径
  - 教育语义映射：模型输出到教育术语的转换
```

**移除内容**（移动到第四章4.5节）:
- ❌ 删除 3.4.2 可解释性分析中的"模态重要性分析表格"
- ❌ 删除具体的实验数据（七类教学风格的模态依赖模式表）

---

### 3.5 数据集构建与风格标注方案【简化3.2节】

**简化内容**:
- 保留数据采集流程概述
- 保留7类风格定义
- 保留标注规范
- ❌ 删除详细的预处理技术细节（移到第四章）
  - 删除视频预处理细节（YOLOv8、DeepSORT、MediaPipe）
  - 删除音频预处理细节（Wav2Vec 2.0、VAD）
  - 删除文本预处理细节（Whisper、BERT）

**新3.5节结构**:
```
3.5 数据集构建与风格标注方案
  3.5.1 数据采集流程
    - 硬件要求
    - 采集策略

  3.5.2 七类风格定义
    - 理论讲授型、耐心细致型等

  3.5.3 标注规范与质量控制
    - 标注流程
    - 一致性检验（Kappa > 0.80）
```

---

### 3.6 本章小结【更新】

更新小结内容，聚焦方法设计：
- 语义驱动分段策略设计
- H-DAR层次化架构设计
- SHAPE跨模态注意力设计
- 可解释性设计原则

---

## 第四章重组方案

### 4.1 实验总体设计（保持不变）
- ✅ 4.1.1 三种模态风格提取
- ✅ 4.1.2 数据集说明
- ✅ 4.1.3 实验环境配置
- ✅ 4.1.4 评估指标体系

---

### 4.2 单模态特征提取的实现与验证【重组】

#### 4.2.1 音频特征提取（Wav2Vec 2.0实现）
**来源**: 保留现有4.2.1节

**内容**:
- ✅ Wav2Vec 2.0技术实现细节
- ✅ 深度声学表征提取
- ✅ 情感分类头微调
- ✅ 音频特征编码汇总（15维）

---

#### 4.2.2 文本特征提取（BERT + H-DAR实现）【重组】

**调整策略**:
- ❌ 删除H-DAR的设计原理（已移到第三章3.3节）
- ✅ 保留H-DAR的训练过程和实现细节
- ✅ 保留对比实验结果

**新4.2.2节内容**:
```
4.2.2 文本特征提取（BERT + H-DAR实现）

（1）BERT语义编码实现
  - 模型选择：BERT-base-chinese
  - 输入处理：[CLS] + tokens + [SEP]
  - 输出：768维语义向量

（2）H-DAR训练过程
  - 数据集：自标注200个语义单元
  - 训练策略：联合训练（α=0.3）
  - 超参数配置
  - 训练曲线

（3）对比实验：H-DAR vs 基线方法【保留】
  - 表：H-DAR vs 关键词规则 vs 单层BERT
  - 关键发现（F1提升0.19）
  - 错误分析与类别混淆

（4）教学风格的意图分布特征【保留】
  - 表：不同风格的核心意图特征

（5）文本特征编码汇总（35维）
```

---

#### 4.2.3 视频特征提取（DeepSORT + ST-GCN实现）
**来源**: 保留现有4.3节内容

**内容**:
- ✅ 4.3.1 DeepSORT稳定追踪算法
  - 消融实验：有无DeepSORT的影响
  - ID稳定性提升25.5%
- ✅ 4.3.2 ST-GCN时序动作识别
  - 网络结构
  - 性能提升17.7%
- ✅ 4.3.3 视频特征编码汇总（20维）

---

### 4.3 核心创新的消融实验【新增】

#### 4.3.1 语义分段 vs 固定分段【完整移动】
**来源**: 从现有4.5节完整移动

**内容**（Line 1921-2169）:
- ✅ 4.5.1 实验设置
- ✅ 4.5.2 语义完整率评估（76.6% → 95.3%）
- ✅ 4.5.3 教学意图识别性能对比（F1: 0.84 → 0.89）
- ✅ 4.5.4 定性分析：语义割裂案例
- ✅ 4.5.5 风格识别性能对比（91.4% → 93.5%）
- ✅ 4.5.6 计算开销分析
- ✅ 4.5.7 统计显著性检验
- ✅ 4.5.8 消融实验总结

**新编号**: 4.3.1

---

#### 4.3.2 H-DAR vs 基线方法【从4.2.2提取】
**来源**: 从4.2.2节的实验部分提取

**内容**（Line 1727-1805）:
- ✅ 对比实验表格
- ✅ H-DAR vs 关键词规则（F1: 0.89 vs 0.70）
- ✅ H-DAR vs 单层BERT-10类（F1: 0.89 vs 0.84）
- ✅ 细粒度意图识别的有效性
- ✅ 错误分析与类别混淆

**新编号**: 4.3.2

---

#### 4.3.3 SHAPE vs 简单融合【从4.4移动】
**来源**: 保留现有4.4节内容

**内容**:
- ✅ 4.4.1 与基线方法的对比
  - SHAPE vs Early Fusion（91.4% vs 85.2%）
  - SHAPE vs Late Fusion（91.4% vs 87.6%）
  - 配对t检验
- ✅ 4.4.2 消融实验
  - 跨模态注意力的贡献（-2.7%, p<0.01）
  - 模块消融实验

**新编号**: 4.3.3

---

### 4.4 整体性能评估【保持】
- ✅ 4.4.1 单模态 vs 多模态
- ✅ 4.4.2 混淆矩阵分析
- ✅ 4.4.3 不同风格的识别性能

---

### 4.5 模态重要性分析【新增】

#### 4.5.1 注意力权重统计（α权重）【从3.4.2移动】
**来源**: 从现有3.4.2节的"模态重要性分析"部分提取

**内容**（Line 1372-1414）:
- ✅ 表3-X：七类教学风格的模态依赖模式（注意力权重分析）
- ✅ 关键发现：
  - 模态依赖的风格差异显著（F=42.3, p<0.001）
  - 音频主导型：情感表达型(0.62)、耐心细致型(0.45)
  - 视觉主导型：互动导向型(0.50)、题目驱动型(0.42)
  - 文本主导型：逻辑推导型(0.53)、理论讲授型(0.43)

**新编号**: 4.5.1

---

#### 4.5.2 不同风格的模态依赖模式【新增】
**内容**:
- 情感表达型：音频0.62
- 互动导向型：视觉0.50
- 逻辑推导型：文本0.53
- 模态依赖的教育学解释

---

### 4.6 本章小结【更新】

更新小结内容，总结实验验证结果：
- 单模态实现的有效性
- 核心创新的消融实验结果
- 整体性能评估
- 模态重要性发现

---

## 实施步骤

### 第一步：重组第三章
1. 保留3.1节
2. 从3.1.2提取"数据分段策略"部分 → 新建3.2节
3. 从4.2.2提取H-DAR设计原理 → 新建3.3节
4. 保留3.3节SHAPE设计 → 重编号为3.4节，新增3.4.4可解释性设计
5. 简化3.2节数据采集 → 重编号为3.5节，删除技术细节
6. 更新3.6本章小结

### 第二步：重组第四章
1. 保留4.1节
2. 调整4.2.1节（音频实现）
3. 调整4.2.2节（文本实现，删除设计原理，保留实验结果）
4. 调整4.2.3节（视频实现，从4.3节重编号）
5. 新建4.3节"核心创新的消融实验"
   - 4.3.1: 从4.5节移动"语义分段消融实验"
   - 4.3.2: 从4.2.2提取"H-DAR对比实验"
   - 4.3.3: 从4.4节移动"SHAPE消融实验"
6. 新建4.4节"整体性能评估"
7. 新建4.5节"模态重要性分析"（从3.4.2移动）
8. 更新4.6本章小结

### 第三步：章节编号连贯性检查
- 检查所有内部引用（如"见3.2节"、"详见4.5节"）
- 更新公式编号
- 更新表格编号
- 更新图片编号

### 第四步：内容过渡自然性检查
- 检查各节之间的衔接语句
- 确保第三章聚焦"设计"
- 确保第四章聚焦"验证"

---

## 关键注意事项

1. **保留所有公式、表格、图注** - 不遗漏任何数学公式
2. **章节编号连贯调整** - 所有引用需要更新
3. **内容过渡自然** - 添加适当的过渡段落
4. **第三章去除实验结果** - 只保留设计原理和动机
5. **第四章保留技术实现** - 包含实现细节和实验验证

---

## 移动内容的行号参考

- **语义分段策略** (3.1.2 → 新3.2): Line 859-919
- **H-DAR设计原理** (4.2.2 → 新3.3): Line 1628-1726
- **模态重要性分析** (3.4.2 → 新4.5.1): Line 1372-1414
- **语义分段消融实验** (4.5 → 新4.3.1): Line 1921-2169
- **H-DAR对比实验** (4.2.2 → 新4.3.2): Line 1727-1805

---

## 预期效果

**第三章**（约6000字 → 约5500字）:
- 更聚焦方法设计
- 逻辑更清晰（从数据→特征→融合）
- 创新点更突出（三个独立小节）

**第四章**（约7000字 → 约7500字）:
- 实验验证更系统
- 消融实验集中呈现
- 技术实现与验证并重

---

**生成时间**: 2026-02-15
**脚本版本**: v1.0
"""

if __name__ == '__main__':
    main()
